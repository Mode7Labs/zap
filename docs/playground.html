<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zap Playground - Live Code Editor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      overflow: hidden;
      height: 100vh;
    }

    .header {
      background: #2a2a2a;
      padding: 1rem 2rem;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #fff;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .btn {
      padding: 0.5rem 1rem;
      background: #4a4a4a;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #5a5a5a;
    }

    .btn-primary {
      background: #667eea;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .container {
      display: flex;
      height: calc(100vh - 65px);
    }

    .sidebar {
      width: 250px;
      background: #2a2a2a;
      border-right: 1px solid #3a3a3a;
      overflow-y: auto;
      padding: 1rem;
    }

    .sidebar h3 {
      font-size: 0.9rem;
      color: #9a9a9a;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .example {
      padding: 0.75rem;
      background: #3a3a3a;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .example:hover {
      background: #4a4a4a;
    }

    .example-title {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .example-desc {
      font-size: 0.8rem;
      color: #9a9a9a;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .editor-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: #3a3a3a;
    }

    .editor-panel {
      background: #1e1e1e;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      background: #2a2a2a;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      border-bottom: 1px solid #3a3a3a;
    }

    #editor {
      flex: 1;
      overflow: auto;
    }

    #code-editor {
      width: 100%;
      height: 100%;
      background: #1e1e1e;
      color: #d4d4d4;
      border: none;
      padding: 1rem;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      outline: none;
    }

    #preview {
      flex: 1;
      border: none;
      background: #0f1419;
    }

    .ai-panel {
      background: #2a2a2a;
      border-top: 1px solid #3a3a3a;
      padding: 1rem;
    }

    .ai-input-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .ai-input {
      flex: 1;
      padding: 0.75rem;
      background: #3a3a3a;
      border: 1px solid #4a4a4a;
      border-radius: 6px;
      color: #fff;
      font-size: 0.9rem;
    }

    .ai-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .ai-status {
      font-size: 0.8rem;
      color: #9a9a9a;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .ai-status.error {
      color: #ff6b6b;
    }

    .ai-status.success {
      color: #51cf66;
    }

    .loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #4a4a4a;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .settings-modal.active {
      display: flex;
    }

    .settings-content {
      background: #2a2a2a;
      padding: 2rem;
      border-radius: 12px;
      width: 500px;
      max-width: 90vw;
    }

    .settings-content h2 {
      margin-bottom: 1.5rem;
    }

    .setting-item {
      margin-bottom: 1.5rem;
    }

    .setting-item label {
      display: block;
      margin-bottom: 0.5rem;
      color: #9a9a9a;
      font-size: 0.9rem;
    }

    .setting-item input {
      width: 100%;
      padding: 0.75rem;
      background: #3a3a3a;
      border: 1px solid #4a4a4a;
      border-radius: 6px;
      color: #fff;
      font-size: 0.9rem;
    }

    .setting-item input:focus {
      outline: none;
      border-color: #667eea;
    }

    .setting-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚ö° Zap Playground</h1>
    <div class="header-actions">
      <span id="ai-indicator" style="font-size: 0.9rem; color: #9a9a9a;">AI: Not configured</span>
      <button class="btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
      <button class="btn" onclick="window.open('index.html', '_blank')">‚Üê Back to Docs</button>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h3>Examples</h3>
      <div class="example" onclick="loadExample('basic')">
        <div class="example-title">Basic Sprite</div>
        <div class="example-desc">Simple colored square</div>
      </div>
      <div class="example" onclick="loadExample('circle')">
        <div class="example-title">Circle</div>
        <div class="example-desc">Perfect circle sprite</div>
      </div>
      <div class="example" onclick="loadExample('animation')">
        <div class="example-title">Animation</div>
        <div class="example-desc">Sprite with tween</div>
      </div>
      <div class="example" onclick="loadExample('interactive')">
        <div class="example-title">Interactive</div>
        <div class="example-desc">Click and drag</div>
      </div>
      <div class="example" onclick="loadExample('particles')">
        <div class="example-title">Particles</div>
        <div class="example-desc">Particle effects</div>
      </div>
      <div class="example" onclick="loadExample('game')">
        <div class="example-title">Mini Game</div>
        <div class="example-desc">Catch the circles</div>
      </div>
    </div>

    <div class="main">
      <div class="editor-container">
        <div class="editor-panel">
          <div class="panel-header">Code Editor</div>
          <div id="editor">
            <textarea id="code-editor" spellcheck="false"></textarea>
          </div>
        </div>
        <div class="editor-panel">
          <div class="panel-header">Live Preview</div>
          <iframe id="preview"></iframe>
        </div>
      </div>

      <div class="ai-panel">
        <div class="ai-input-container">
          <input
            type="text"
            id="ai-prompt"
            class="ai-input"
            placeholder="Describe what you want to build... (e.g., 'add a red circle that follows the mouse')"
            onkeypress="handlePromptKeypress(event)"
          />
          <button class="btn btn-primary" onclick="generateCode()">ü§ñ Generate</button>
        </div>
        <div id="ai-status" class="ai-status"></div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="settings-modal">
    <div class="settings-content">
      <h2>Settings</h2>
      <div class="setting-item">
        <label>OpenAI API Key</label>
        <input
          type="password"
          id="api-key-input"
          placeholder="sk-..."
        />
        <p style="font-size: 0.8rem; color: #9a9a9a; margin-top: 0.5rem;">
          Your API key is stored locally and never sent to our servers.
          <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #667eea;">Get an API key</a>
        </p>
      </div>
      <div class="setting-actions">
        <button class="btn" onclick="closeSettings()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Example code snippets
    const examples = {
      basic: `import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';

const game = new Game({
  width: 800,
  height: 600,
  backgroundColor: '#1a1a2e',
  parent: '#app'
});

const scene = new Scene();

const sprite = new Sprite({
  x: 400,
  y: 300,
  width: 100,
  height: 100,
  color: '#667eea',
  radius: 12
});

scene.add(sprite);
game.setScene(scene);
game.start();`,

      circle: `import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';

const game = new Game({
  width: 800,
  height: 600,
  backgroundColor: '#1a1a2e',
  parent: '#app'
});

const scene = new Scene();

const circle = new Sprite({
  x: 400,
  y: 300,
  width: 100,
  height: 100,
  radius: 50,
  color: '#ff6b6b'
});

scene.add(circle);
game.setScene(scene);
game.start();`,

      animation: `import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';

const game = new Game({
  width: 800,
  height: 600,
  backgroundColor: '#1a1a2e',
  parent: '#app'
});

const scene = new Scene();

const sprite = new Sprite({
  x: 100,
  y: 300,
  width: 80,
  height: 80,
  color: '#51cf66',
  radius: 40
});

scene.add(sprite);

// Animate back and forth
function animate() {
  sprite.tween(
    { x: 700 },
    {
      duration: 2000,
      easing: 'easeInOutCubic',
      onComplete: () => {
        sprite.tween(
          { x: 100 },
          { duration: 2000, easing: 'easeInOutCubic', onComplete: animate }
        );
      }
    }
  );
}

animate();
game.setScene(scene);
game.start();`,

      interactive: `import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';

const game = new Game({
  width: 800,
  height: 600,
  backgroundColor: '#1a1a2e',
  parent: '#app'
});

const scene = new Scene();

const sprite = new Sprite({
  x: 400,
  y: 300,
  width: 100,
  height: 100,
  radius: 50,
  color: '#667eea',
  interactive: true
});

sprite.on('tap', () => {
  sprite.tween(
    { rotation: sprite.rotation + Math.PI * 2, scaleX: 1.5, scaleY: 1.5 },
    { duration: 300, easing: 'easeOutBack' }
  ).then(() => {
    sprite.tween(
      { scaleX: 1, scaleY: 1 },
      { duration: 200 }
    );
  });
});

sprite.on('drag', (e) => {
  sprite.x = e.position.x;
  sprite.y = e.position.y;
});

scene.add(sprite);
game.setScene(scene);
game.start();`,

      particles: `import { Game, Scene, ParticleEmitter } from 'https://esm.sh/@mode-7/zap@0.1.2';

const game = new Game({
  width: 800,
  height: 600,
  backgroundColor: '#1a1a2e',
  parent: '#app'
});

const scene = new Scene();

const emitter = new ParticleEmitter({
  x: 400,
  y: 300,
  rate: 50,
  colors: ['#ff6b6b', '#51cf66', '#667eea', '#ffd43b'],
  velocityRange: {
    min: { x: -100, y: -100 },
    max: { x: 100, y: 100 }
  },
  sizeRange: { min: 3, max: 8 },
  lifetimeRange: { min: 1, max: 2 }
});

scene.add(emitter);
game.setScene(scene);
game.start();`,

      game: `import { Game, Scene, Sprite, Text } from 'https://esm.sh/@mode-7/zap@0.1.2';

const game = new Game({
  width: 800,
  height: 600,
  backgroundColor: '#1a1a2e',
  parent: '#app'
});

const scene = new Scene();

let score = 0;
const scoreText = new Text({
  text: 'Score: 0',
  x: 400,
  y: 50,
  fontSize: 24,
  color: '#fff',
  align: 'center'
});
scene.add(scoreText);

const player = new Sprite({
  x: 400,
  y: 500,
  width: 60,
  height: 60,
  radius: 30,
  color: '#667eea',
  interactive: true
});

player.on('drag', (e) => {
  player.x = Math.max(30, Math.min(770, e.position.x));
});

scene.add(player);

function spawnCircle() {
  const circle = new Sprite({
    x: Math.random() * 760 + 20,
    y: -50,
    width: 40,
    height: 40,
    radius: 20,
    color: '#51cf66'
  });

  scene.add(circle);

  circle.tween(
    { y: 650 },
    { duration: 3000, easing: 'linear' }
  ).then(() => scene.remove(circle));

  const checkCollision = setInterval(() => {
    const dx = circle.x - player.x;
    const dy = circle.y - player.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance < 50) {
      score++;
      scoreText.text = \`Score: \${score}\`;
      scene.remove(circle);
      clearInterval(checkCollision);

      player.tween(
        { scaleX: 1.2, scaleY: 1.2 },
        { duration: 100 }
      ).then(() => {
        player.tween({ scaleX: 1, scaleY: 1 }, { duration: 100 });
      });
    }
  }, 50);
}

setInterval(spawnCircle, 1000);

game.setScene(scene);
game.start();`
    };

    let currentCode = examples.basic;
    const editor = document.getElementById('code-editor');
    const preview = document.getElementById('preview');

    // Auto-update preview on code change
    let updateTimeout;
    editor.addEventListener('input', () => {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(() => {
        updatePreview();
      }, 1000);
    });

    // Update preview
    function updatePreview() {
      currentCode = editor.value;
      const html = `<!DOCTYPE html>
<html>
<head>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #0f1419; }
    #app { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
${currentCode}
  </script>
</body>
</html>`;

      preview.srcdoc = html;
    }

    // Load example
    function loadExample(name) {
      editor.value = examples[name];
      updatePreview();
    }

    // Settings
    function openSettings() {
      const modal = document.getElementById('settings-modal');
      const input = document.getElementById('api-key-input');
      input.value = localStorage.getItem('openai_api_key') || '';
      modal.classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('active');
    }

    function saveSettings() {
      const apiKey = document.getElementById('api-key-input').value.trim();
      if (apiKey) {
        localStorage.setItem('openai_api_key', apiKey);
        updateAIIndicator();
        closeSettings();
      }
    }

    function updateAIIndicator() {
      const indicator = document.getElementById('ai-indicator');
      const hasKey = !!localStorage.getItem('openai_api_key');
      indicator.textContent = hasKey ? 'AI: Ready ‚úì' : 'AI: Not configured';
      indicator.style.color = hasKey ? '#51cf66' : '#9a9a9a';
    }

    // AI Code Generation
    async function generateCode() {
      const apiKey = localStorage.getItem('openai_api_key');
      if (!apiKey) {
        showStatus('Please configure your OpenAI API key in settings', 'error');
        return;
      }

      const prompt = document.getElementById('ai-prompt').value.trim();
      if (!prompt) {
        showStatus('Please enter a description', 'error');
        return;
      }

      showStatus('Generating code...', 'loading');

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: `You are a code generator for the Zap game engine. Generate clean, working JavaScript code using the Zap API.

Available imports from 'https://esm.sh/@mode-7/zap@0.1.2':
- Game, Scene, Sprite, Text, ParticleEmitter, AnimatedSprite, Button

Common patterns:
- Create game: new Game({ width, height, backgroundColor, parent: '#app' })
- Create sprite: new Sprite({ x, y, width, height, color, radius, interactive })
- For circles: width === height and radius === width/2
- Tweens: sprite.tween({ x, y, rotation, scaleX, scaleY }, { duration, easing })
- Events: sprite.on('tap', fn), sprite.on('drag', fn), sprite.on('swipe', fn)

Always:
1. Import from CDN
2. Create game with parent: '#app'
3. Create scene
4. Add entities to scene
5. game.setScene(scene) and game.start()

Only output the JavaScript code, no explanations.`
              },
              {
                role: 'user',
                content: `Current code:\n\`\`\`javascript\n${currentCode}\n\`\`\`\n\nUser request: ${prompt}\n\nGenerate the updated code.`
              }
            ],
            temperature: 0.7,
            max_tokens: 2000
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'API request failed');
        }

        const data = await response.json();
        const generatedCode = data.choices[0].message.content
          .replace(/```javascript\n?/g, '')
          .replace(/```\n?/g, '')
          .trim();

        editor.value = generatedCode;
        updatePreview();
        showStatus('Code generated successfully!', 'success');
        document.getElementById('ai-prompt').value = '';

      } catch (error) {
        showStatus(`Error: ${error.message}`, 'error');
      }
    }

    function showStatus(message, type) {
      const status = document.getElementById('ai-status');
      status.className = `ai-status ${type}`;

      if (type === 'loading') {
        status.innerHTML = `<span class="loading"></span> ${message}`;
      } else {
        status.textContent = message;
      }

      if (type !== 'loading') {
        setTimeout(() => {
          status.textContent = '';
        }, 5000);
      }
    }

    function handlePromptKeypress(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        generateCode();
      }
    }

    // Initialize
    loadExample('basic');
    updateAIIndicator();

    // Close settings modal when clicking outside
    document.getElementById('settings-modal').addEventListener('click', (e) => {
      if (e.target.id === 'settings-modal') {
        closeSettings();
      }
    });
  </script>
</body>
</html>
