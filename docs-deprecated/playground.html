<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zap Playground</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      overflow: hidden;
      height: 100vh;
    }
    .header {
      background: #2a2a2a;
      padding: 1rem 2rem;
      border-bottom: 1px solid #3a3a3a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.5rem; font-weight: 600; color: #fff; }
    .btn {
      padding: 0.5rem 1rem;
      background: #4a4a4a;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn:hover { background: #5a5a5a; }
    .container { display: flex; height: calc(100vh - 65px); }
    .sidebar {
      width: 250px;
      background: #2a2a2a;
      border-right: 1px solid #3a3a3a;
      overflow-y: auto;
      padding: 1rem;
    }
    .example {
      padding: 0.75rem;
      background: #3a3a3a;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    .example:hover { background: #4a4a4a; }
    .main { flex: 1; display: flex; flex-direction: column; }
    .editor-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: #3a3a3a;
    }
    .editor-panel { background: #1e1e1e; display: flex; flex-direction: column; }
    .panel-header {
      background: #2a2a2a;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-bottom: 1px solid #3a3a3a;
      flex-shrink: 0;
    }
    #editor-wrapper {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    .CodeMirror {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      height: 100% !important;
      font-size: 14px;
    }
    #preview { flex: 1; border: none; background: #0f1419; }
    .ai-panel {
      background: #2a2a2a;
      border-top: 1px solid #3a3a3a;
      padding: 1rem;
      flex-shrink: 0;
    }
    .ai-input-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .ai-input {
      flex: 1;
      padding: 0.75rem;
      background: #3a3a3a;
      border: 1px solid #4a4a4a;
      border-radius: 6px;
      color: #fff;
      font-size: 0.9rem;
    }
    .ai-input:focus {
      outline: none;
      border-color: #667eea;
    }
    .ai-status {
      font-size: 0.8rem;
      color: #9a9a9a;
    }
    .ai-status.error { color: #ff6b6b; }
    .ai-status.success { color: #51cf66; }
    .btn-ai {
      background: #667eea;
    }
    .btn-ai:hover {
      background: #5568d3;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚ö° Zap Playground</h1>
    <div class="header-actions">
      <span id="ai-indicator" style="font-size: 0.9rem; color: #9a9a9a; margin-right: 1rem;">AI: Not configured</span>
      <button class="btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
      <button class="btn" onclick="window.open('demos.html')">Demos</button>
      <button class="btn" onclick="window.open('index.html')">‚Üê Home</button>
    </div>
  </div>

  <div id="settings-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:1000;">
    <div style="background:#2a2a2a; padding:2rem; border-radius:12px; width:500px; max-width:90vw;">
      <h2 style="margin-bottom:1.5rem;">Settings</h2>
      <div style="margin-bottom:1.5rem;">
        <label style="display:block; margin-bottom:0.5rem; color:#9a9a9a; font-size:0.9rem;">OpenAI API Key</label>
        <input type="password" id="api-key-input" placeholder="sk-..." style="width:100%; padding:0.75rem; background:#3a3a3a; border:1px solid #4a4a4a; border-radius:6px; color:#fff; font-size:0.9rem;">
        <p style="font-size:0.8rem; color:#9a9a9a; margin-top:0.5rem;">
          Your API key is stored locally. <a href="https://platform.openai.com/api-keys" target="_blank" style="color:#667eea;">Get an API key</a>
        </p>
      </div>
      <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
        <button class="btn" onclick="closeSettings()">Cancel</button>
        <button class="btn btn-ai" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="sidebar">
      <div class="example" onclick="loadBasic()">Basic Sprite</div>
      <div class="example" onclick="loadCircle()">Circle</div>
      <div class="example" onclick="loadAnimation()">Animation</div>
      <div class="example" onclick="loadInteractive()">Interactive</div>
      <div class="example" onclick="loadParticles()">Particles</div>
      <div class="example" onclick="loadGame()">Mini Game</div>
    </div>
    <div class="main">
      <div class="editor-container">
        <div class="editor-panel">
          <div class="panel-header">Code Editor</div>
          <div id="editor-wrapper">
            <textarea id="code"></textarea>
          </div>
        </div>
        <div class="editor-panel">
          <div class="panel-header">Live Preview</div>
          <iframe id="preview"></iframe>
        </div>
      </div>

      <div class="ai-panel">
        <div class="ai-input-container">
          <input
            type="text"
            id="ai-prompt"
            class="ai-input"
            placeholder="Describe what you want to build... (e.g., 'add a red circle that bounces')"
            onkeypress="if(event.key==='Enter')generateCode()"
          />
          <button class="btn btn-ai" onclick="generateCode()">ü§ñ Generate</button>
        </div>
        <div id="ai-status" class="ai-status"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
  <script type="module">
    import { ZAP_SYSTEM_PROMPT, ZAP_TOOLS, handleToolCall } from './zap-tools.js';

    const editor = CodeMirror.fromTextArea(document.getElementById('code'), {
      mode: 'javascript',
      theme: 'monokai',
      lineNumbers: true,
      autofocus: true
    });

    window.updatePreview = function() {
      const code = editor.getValue();
      // Replace CDN import with local dist for testing
      const localCode = code.replace(
        "from 'https://esm.sh/@mode-7/zap@0.1.2'",
        "from 'http://localhost:3000/dist/index.mjs'"
      );
      const html =
        '<!DOCTYPE html><html><head><style>body{margin:0;padding:0;overflow:hidden;background:#0f1419}#app{width:100vw;height:100vh}</style></head>' +
        '<body><div id="app"></div><script type="module">' +
        'const GAME_WIDTH = window.innerWidth;\nconst GAME_HEIGHT = window.innerHeight;\n' +
        localCode +
        '<\/script></body></html>';
      document.getElementById('preview').srcdoc = html;
    }

    editor.on('change', function() {
      clearTimeout(window.updateTimer);
      window.updateTimer = setTimeout(updatePreview, 1000);
    });

    window.loadBasic = function() {
      editor.setValue("import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';\n\nconst game = new Game({\n  width: GAME_WIDTH,\n  height: GAME_HEIGHT,\n  backgroundColor: '#1a1a2e',\n  parent: '#app'\n});\n\nconst scene = new Scene();\n\nconst sprite = new Sprite({\n  x: GAME_WIDTH / 2,\n  y: GAME_HEIGHT / 2,\n  width: 100,\n  height: 100,\n  color: '#667eea',\n  radius: 12\n});\n\nscene.add(sprite);\ngame.setScene(scene);\ngame.start();");
      updatePreview();
    }

    window.loadCircle = function() {
      editor.setValue("import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';\n\nconst game = new Game({\n  width: GAME_WIDTH,\n  height: GAME_HEIGHT,\n  backgroundColor: '#1a1a2e',\n  parent: '#app'\n});\n\nconst scene = new Scene();\n\nconst circle = new Sprite({\n  x: GAME_WIDTH / 2,\n  y: GAME_HEIGHT / 2,\n  width: 100,\n  height: 100,\n  radius: 50,\n  color: '#ff6b6b'\n});\n\nscene.add(circle);\ngame.setScene(scene);\ngame.start();");
      updatePreview();
    }

    window.loadAnimation = function() {
      editor.setValue("import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';\n\nconst game = new Game({\n  width: GAME_WIDTH,\n  height: GAME_HEIGHT,\n  backgroundColor: '#1a1a2e',\n  parent: '#app'\n});\n\nconst scene = new Scene();\n\nconst sprite = new Sprite({\n  x: 100,\n  y: GAME_HEIGHT / 2,\n  width: 80,\n  height: 80,\n  color: '#51cf66',\n  radius: 40\n});\n\nscene.add(sprite);\n\nfunction animate() {\n  sprite.tween(\n    { x: GAME_WIDTH - 100 },\n    {\n      duration: 2000,\n      easing: 'easeInOutCubic',\n      onComplete: () => {\n        sprite.tween(\n          { x: 100 },\n          { duration: 2000, easing: 'easeInOutCubic', onComplete: animate }\n        );\n      }\n    }\n  );\n}\n\nanimate();\ngame.setScene(scene);\ngame.start();");
      updatePreview();
    }

    window.loadInteractive = function() {
      editor.setValue("import { Game, Scene, Sprite } from 'https://esm.sh/@mode-7/zap@0.1.2';\n\nconst game = new Game({\n  width: GAME_WIDTH,\n  height: GAME_HEIGHT,\n  backgroundColor: '#1a1a2e',\n  parent: '#app'\n});\n\nconst scene = new Scene();\n\nconst sprite = new Sprite({\n  x: GAME_WIDTH / 2,\n  y: GAME_HEIGHT / 2,\n  width: 100,\n  height: 100,\n  radius: 50,\n  color: '#667eea',\n  interactive: true\n});\n\nsprite.on('tap', () => {\n  sprite.tween(\n    { rotation: sprite.rotation + Math.PI * 2, scaleX: 1.5, scaleY: 1.5 },\n    { duration: 300, easing: 'easeOutBack' }\n  ).then(() => {\n    sprite.tween(\n      { scaleX: 1, scaleY: 1 },\n      { duration: 200 }\n    );\n  });\n});\n\nsprite.on('drag', (e) => {\n  sprite.x = e.position.x;\n  sprite.y = e.position.y;\n});\n\nscene.add(sprite);\ngame.setScene(scene);\ngame.start();");
      updatePreview();
    }

    window.loadParticles = function() {
      editor.setValue("import { Game, Scene, ParticleEmitter } from 'https://esm.sh/@mode-7/zap@0.1.2';\n\nconst game = new Game({\n  width: GAME_WIDTH,\n  height: GAME_HEIGHT,\n  backgroundColor: '#1a1a2e',\n  parent: '#app'\n});\n\nconst scene = new Scene();\n\nconst emitter = new ParticleEmitter({\n  x: GAME_WIDTH / 2,\n  y: GAME_HEIGHT / 2,\n  rate: 50,\n  colors: ['#ff6b6b', '#51cf66', '#667eea', '#ffd43b'],\n  velocityRange: {\n    min: { x: -100, y: -100 },\n    max: { x: 100, y: 100 }\n  },\n  sizeRange: { min: 3, max: 8 },\n  lifetimeRange: { min: 1, max: 2 }\n});\n\nscene.add(emitter);\ngame.setScene(scene);\ngame.start();");
      updatePreview();
    }

    window.loadGame = function() {
      editor.setValue("import { Game, Scene, Sprite, Text } from 'https://esm.sh/@mode-7/zap@0.1.2';\n\nconst game = new Game({\n  width: GAME_WIDTH,\n  height: GAME_HEIGHT,\n  backgroundColor: '#1a1a2e',\n  parent: '#app'\n});\n\nconst scene = new Scene();\n\nlet score = 0;\nconst scoreText = new Text({\n  text: 'Score: 0',\n  x: GAME_WIDTH / 2,\n  y: 50,\n  fontSize: 24,\n  color: '#fff',\n  align: 'center'\n});\nscene.add(scoreText);\n\nconst player = new Sprite({\n  x: GAME_WIDTH / 2,\n  y: GAME_HEIGHT - 100,\n  width: 60,\n  height: 60,\n  radius: 30,\n  color: '#667eea',\n  interactive: true,\n  checkCollisions: true,\n  collisionTags: ['collectible']\n});\n\nplayer.on('drag', (e) => {\n  player.x = Math.max(30, Math.min(GAME_WIDTH - 30, e.position.x));\n});\n\nplayer.on('collide', (event) => {\n  const circle = event.other;\n  score++;\n  scoreText.text = 'Score: ' + score;\n  scene.remove(circle);\n\n  player.tween(\n    { scaleX: 1.2, scaleY: 1.2 },\n    { duration: 100 }\n  ).then(() => {\n    player.tween({ scaleX: 1, scaleY: 1 }, { duration: 100 });\n  });\n});\n\nscene.add(player);\n\nfunction spawnCircle() {\n  const circle = new Sprite({\n    x: Math.random() * (GAME_WIDTH - 40) + 20,\n    y: -50,\n    width: 40,\n    height: 40,\n    radius: 20,\n    color: '#51cf66'\n  });\n\n  circle.addTag('collectible');\n  scene.add(circle);\n\n  circle.tween(\n    { y: GAME_HEIGHT + 50 },\n    { duration: 3000, easing: 'linear' }\n  ).then(() => {\n    scene.remove(circle);\n  });\n}\n\nsetInterval(spawnCircle, 1000);\n\ngame.setScene(scene);\ngame.start();");
      updatePreview();
    }

    // Settings
    window.openSettings = function() {
      document.getElementById('settings-modal').style.display = 'flex';
      document.getElementById('api-key-input').value = localStorage.getItem('openai_api_key') || '';
    }

    window.closeSettings = function() {
      document.getElementById('settings-modal').style.display = 'none';
    }

    window.saveSettings = function() {
      const apiKey = document.getElementById('api-key-input').value.trim();
      if (apiKey) {
        localStorage.setItem('openai_api_key', apiKey);
        updateAIIndicator();
        closeSettings();
      }
    }

    function updateAIIndicator() {
      const indicator = document.getElementById('ai-indicator');
      const hasKey = !!localStorage.getItem('openai_api_key');
      indicator.textContent = hasKey ? 'AI: Ready ‚úì' : 'AI: Not configured';
      indicator.style.color = hasKey ? '#51cf66' : '#9a9a9a';
    }

    // AI Code Generation with tool calling
    window.generateCode = async function() {
      const apiKey = localStorage.getItem('openai_api_key');
      if (!apiKey) {
        showStatus('Please configure your OpenAI API key in settings', 'error');
        return;
      }

      const prompt = document.getElementById('ai-prompt').value.trim();
      if (!prompt) {
        showStatus('Please enter a description', 'error');
        return;
      }

      showStatus('ü§ñ AI is thinking...', '');

      try {
        const currentCode = editor.getValue();
        const messages = [
          {
            role: 'system',
            content: ZAP_SYSTEM_PROMPT
          },
          {
            role: 'user',
            content: 'Current code:\n```javascript\n' + currentCode + '\n```\n\nUser request: ' + prompt + '\n\nGenerate the updated code using Zap API.'
          }
        ];

        let iterationCount = 0;
        const MAX_ITERATIONS = 10;
        let finalCode = null;

        // Tool calling loop
        while (iterationCount < MAX_ITERATIONS && !finalCode) {
          iterationCount++;

          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify({
              model: 'gpt-4o-mini',
              messages: messages,
              tools: ZAP_TOOLS,
              tool_choice: 'auto',
              temperature: 0.7,
              max_tokens: 2000
            })
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'API request failed');
          }

          const data = await response.json();
          const assistantMessage = data.choices[0].message;
          messages.push(assistantMessage);

          // Check if AI wants to call tools
          if (assistantMessage.tool_calls && assistantMessage.tool_calls.length > 0) {
            showStatus(`üîç AI is exploring Zap docs (${assistantMessage.tool_calls.length} queries)...`, '');

            // Process each tool call
            for (const toolCall of assistantMessage.tool_calls) {
              const toolName = toolCall.function.name;
              const toolArgs = JSON.parse(toolCall.function.arguments);

              console.log('AI called tool:', toolName, toolArgs);

              // Execute the tool
              const toolResult = handleToolCall(toolName, toolArgs);

              // Add tool response to conversation
              messages.push({
                role: 'tool',
                tool_call_id: toolCall.id,
                content: JSON.stringify(toolResult)
              });
            }
          } else {
            // AI returned final code
            finalCode = assistantMessage.content;
          }
        }

        if (!finalCode) {
          throw new Error('AI took too long to generate code. Please try a simpler request.');
        }

        // Clean up code
        const cleanCode = finalCode
          .replace(/```javascript\n?/g, '')
          .replace(/```\n?/g, '')
          .trim();

        editor.setValue(cleanCode);
        updatePreview();
        showStatus('‚úì Code generated successfully!', 'success');
        document.getElementById('ai-prompt').value = '';

      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
        console.error('AI Error:', error);
      }
    }

    function showStatus(message, type) {
      const status = document.getElementById('ai-status');
      status.className = 'ai-status ' + type;
      status.textContent = message;

      if (type !== '') {
        setTimeout(function() {
          status.textContent = '';
        }, 5000);
      }
    }

    // Click outside modal to close
    document.getElementById('settings-modal').onclick = function(e) {
      if (e.target.id === 'settings-modal') closeSettings();
    };

    loadBasic();
    updateAIIndicator();
  </script>
</body>
</html>
