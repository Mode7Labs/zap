<!DOCTYPE html>
<html>
<head>
  <title>Pong Debug</title>
  <style>
    body { margin: 0; padding: 20px; font-family: monospace; }
    #app { width: 800px; height: 600px; border: 2px solid #333; }
    #log { margin-top: 20px; white-space: pre-wrap; font-size: 12px; max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="log"></div>

  <script type="module">
    import { Game, Scene, Sprite } from './dist/index.mjs';

    const log = document.getElementById('log');
    function addLog(msg) {
      log.textContent += msg + '\n';
      log.scrollTop = log.scrollHeight;
    }

    const game = new Game({
      parent: '#app',
      backgroundColor: '#0f3460',
      width: 800,
      height: 600
    });

    const scene = new Scene();

    const paddleWidth = 14;
    const paddleHeight = 90;

    // Right paddle
    const rightPaddle = new Sprite({
      x: 760,
      y: 300,
      width: paddleWidth,
      height: paddleHeight,
      color: '#e94560',
      checkCollisions: true,
      static: true
    });
    scene.add(rightPaddle);

    // Ball
    const ball = new Sprite({
      x: 400,
      y: 300,
      width: 18,
      height: 18,
      radius: 9,
      color: '#f7f7f7',
      vx: 340,
      vy: 50,
      friction: 1,
      bounciness: 1,
      gravity: 0,
      checkCollisions: true
    });
    scene.add(ball);

    // THIS IS THE PROBLEMATIC CODE FROM PONG
    ball.on('collisionenter', (e) => {
      if (e.other === rightPaddle) {
        addLog(`\n>>> User collision handler triggered`);
        addLog(`    BEFORE: vx=${ball.vx.toFixed(2)}, vy=${ball.vy.toFixed(2)}`);

        const speedBoost = 1.05;
        ball.vx *= -speedBoost; // This is the problem!
        const offset = (ball.y - e.other.y) / (paddleHeight / 2);
        ball.vy += offset * 140;

        addLog(`    AFTER: vx=${ball.vx.toFixed(2)}, vy=${ball.vy.toFixed(2)}\n`);
      }
    });

    let frameCount = 0;
    let colliding = false;

    scene.on('update', () => {
      frameCount++;

      if (ball.x > 700 && frameCount < 150) {
        addLog(`Frame ${frameCount}: ball.x=${ball.x.toFixed(2)}, vx=${ball.vx.toFixed(2)}`);
      }
    });

    ball.on('collisionenter', (e) => {
      if (e.other === rightPaddle) {
        colliding = true;
        addLog(`>>> COLLISION ENTER frame ${frameCount}: ball.x=${ball.x.toFixed(2)}, vx=${ball.vx.toFixed(2)}`);
      }
    });

    ball.on('collide', (e) => {
      if (colliding && frameCount < 150) {
        addLog(`... still colliding frame ${frameCount}: ball.x=${ball.x.toFixed(2)}, vx=${ball.vx.toFixed(2)}`);
      }
    });

    ball.on('collisionexit', (e) => {
      if (e.other === rightPaddle) {
        colliding = false;
        addLog(`<<< COLLISION EXIT frame ${frameCount}: ball.x=${ball.x.toFixed(2)}, vx=${ball.vx.toFixed(2)}\n`);
      }
    });

    game.setScene(scene);
    game.start();

    addLog('Testing Pong collision with user handler that flips velocity...');
    addLog(`Ball starts at x=${ball.x}, vx=${ball.vx}, vy=${ball.vy}`);
    addLog(`Paddle at x=${rightPaddle.x}\n`);
  </script>
</body>
</html>
