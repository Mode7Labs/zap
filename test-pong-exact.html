<!DOCTYPE html>
<html>
<head>
  <title>Exact Pong Test</title>
  <style>
    body { margin: 0; padding: 0; }
    #app { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { Game, Scene, Sprite, Text } from './dist/index.mjs';

    const game = new Game({
      parent: '#app',
      backgroundColor: '#0f3460',
      responsive: true
    });

    const scene = new Scene();

    // Center line (visual only - no collisions)
    const centerLine = new Sprite({
      x: game.width / 2,
      y: game.height / 2,
      width: 4,
      height: game.height,
      color: '#16213e',
      static: true,
      checkCollisions: false,
      interactive: false
    });
    scene.add(centerLine);

    // Paddles
    const paddleWidth = 14;
    const paddleHeight = 90;

    const leftPaddle = new Sprite({
      x: 40,
      y: game.height / 2,
      width: paddleWidth,
      height: paddleHeight,
      color: '#51cf66',
      interactive: true,
      checkCollisions: true,
      static: true
    });

    const rightPaddle = new Sprite({
      x: game.width - 40,
      y: game.height / 2,
      width: paddleWidth,
      height: paddleHeight,
      color: '#e94560',
      checkCollisions: true,
      static: true
    });

    scene.add(leftPaddle);
    scene.add(rightPaddle);

    // Walls (top/bottom)
    const wallThickness = 20;
    const topWall = new Sprite({
      x: game.width / 2,
      y: wallThickness / 2,
      width: game.width,
      height: wallThickness,
      color: '#16213e',
      static: true,
      checkCollisions: true
    });
    const bottomWall = new Sprite({
      x: game.width / 2,
      y: game.height - wallThickness / 2,
      width: game.width,
      height: wallThickness,
      color: '#16213e',
      static: true,
      checkCollisions: true
    });
    scene.add(topWall);
    scene.add(bottomWall);

    // Ball
    const ball = new Sprite({
      x: game.width / 2,
      y: game.height / 2,
      width: 18,
      height: 18,
      radius: 9,
      color: '#f7f7f7',
      vx: 0,
      vy: 0,
      friction: 1,
      bounciness: 1,
      gravity: 0,
      checkCollisions: true
    });
    scene.add(ball);

    // Debug text
    const debugText = new Text({
      text: 'Debug: waiting...',
      x: game.width / 2,
      y: 60,
      fontSize: 14,
      color: '#fff',
      align: 'center'
    });
    scene.add(debugText);

    function resetBall(toLeft = false) {
      ball.x = game.width / 2;
      ball.y = game.height / 2;
      ball.vx = 0;
      ball.vy = 0;

      setTimeout(() => {
        const speed = 340;
        const angle = (Math.random() * 0.6 - 0.3);
        const dir = toLeft ? -1 : 1;
        ball.vx = dir * speed * Math.cos(angle);
        ball.vy = speed * Math.sin(angle);
        debugText.text = `Ball launched! vx=${ball.vx.toFixed(0)}, vy=${ball.vy.toFixed(0)}`;
      }, 350);
    }

    resetBall(Math.random() < 0.5);

    ball.bounciness = 1;
    ball.checkCollisions = true;
    centerLine.checkCollisions = false;

    // Collision handler
    ball.on('collisionenter', (e) => {
      let entityName = 'unknown';
      if (e.other === leftPaddle) entityName = 'leftPaddle';
      else if (e.other === rightPaddle) entityName = 'rightPaddle';
      else if (e.other === topWall) entityName = 'topWall';
      else if (e.other === bottomWall) entityName = 'bottomWall';
      else if (e.other === centerLine) entityName = 'centerLine (SHOULD NOT HAPPEN!)';

      debugText.text = `Collision with ${entityName}`;
      console.log(`Collision with ${entityName}`);

      if (e.other === leftPaddle || e.other === rightPaddle) {
        const offset = (ball.y - e.other.y) / (paddleHeight / 2);
        ball.vy += offset * 140;
      }
    });

    // Simple AI for right paddle
    scene.on('update', () => {
      const targetY = ball.y;
      const lerp = 0.12;
      rightPaddle.y += (targetY - rightPaddle.y) * lerp;

      const minY = wallThickness + paddleHeight / 2;
      const maxY = game.height - wallThickness - paddleHeight / 2;
      rightPaddle.y = Math.max(minY, Math.min(maxY, rightPaddle.y));
      leftPaddle.y = Math.max(minY, Math.min(maxY, leftPaddle.y));
    });

    game.on('tap', (event) => {
      if (event.target) return;
      leftPaddle.y = event.position.y;
    });

    game.setScene(scene);
    game.start();
  </script>
</body>
</html>
